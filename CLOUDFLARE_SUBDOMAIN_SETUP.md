# Cloudflare + PythonAnywhereã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ - é«˜é€ŸåŒ–ã‚¬ã‚¤ãƒ‰

**ç„¡æ–™ + æœ€é€Ÿé‡è¦–** ã§PythonAnywhereã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ`1kzma1.pythonanywhere.com`ï¼‰ã®ã¾ã¾é«˜é€ŸåŒ–ã—ã¾ã™ã€‚

---

## ğŸ¯ æ–¹æ³•ã®é¸æŠ

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: **CNAMEè¨­å®šï¼ˆæ¨å¥¨ãƒ»æœ€é€Ÿï¼‰ â­**
```
ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: 5åˆ†
åŠ¹æœ: æœ€å¤§
é›£æ˜“åº¦: ç°¡å˜
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: Cloudflare Workersï¼ˆé«˜åº¦ï¼‰
```
ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: 30åˆ†
åŠ¹æœ: éå¸¸ã«é«˜ã„
é›£æ˜“åº¦: ä¸­ç¨‹åº¦
```

**ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³1ï¼ˆCNAMEè¨­å®šï¼‰ã‚’æ¡ç”¨ã—ã¾ã™ã€‚**

---

## âœ… äº‹å‰ç¢ºèª

ã‚ãªãŸã®ã‚µã‚¤ãƒˆ:
- URL: `https://1kzma1.pythonanywhere.com`
- ã‚µãƒ¼ãƒãƒ¼: PythonAnywhere
- ãƒ‰ãƒ¡ã‚¤ãƒ³: ãªã—ï¼ˆPythonAnywhereã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰

---

## ğŸš€ å®Ÿè£…æ‰‹é †ï¼ˆå…¨5ã‚¹ãƒ†ãƒƒãƒ—ãƒ»15åˆ†ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆ3åˆ†ï¼‰

```
1. https://www.cloudflare.com ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€ŒSign Upã€ã‚¯ãƒªãƒƒã‚¯
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
5. ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº†
```

âœ… **Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã£ãŸ**

---

### ã‚¹ãƒ†ãƒƒãƒ—2: Cloudflare Free ãƒ—ãƒ©ãƒ³è¨­å®šï¼ˆ2åˆ†ï¼‰

#### 2-1: Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å·¦ä¸‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼

```
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š â†’ ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—
â†’ ã€ŒFree ãƒ—ãƒ©ãƒ³ã€ç¢ºèª
```

**ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ååˆ†ã§ã™ã€‚** âœ…

---

### ã‚¹ãƒ†ãƒƒãƒ—3: Cloudflare Workers ãƒ«ãƒ¼ãƒˆè¨­å®šï¼ˆ5åˆ†ï¼‰

**Cloudflare Workers** = Cloudflareã®ã‚µãƒ¼ãƒãƒ¼ã§å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·

#### 3-1: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã€ŒWorkers & Pagesã€

```
å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ Workers & Pages
â†’ ã€ŒCreateã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

#### 3-2: ãƒ¯ãƒ¼ã‚«ãƒ¼ä½œæˆ

```
1. ã€ŒCreate Workerã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã§OKï¼ˆä¾‹: worker-1ï¼‰
3. å³ä¸‹ã€ŒDeployã€ã‚’ã‚¯ãƒªãƒƒã‚¯
```

ãƒ¯ãƒ¼ã‚«ãƒ¼URL ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:
```
https://your-worker.your-subdomain.workers.dev
```

#### 3-3: ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ç·¨é›†

ã€ŒEdit Codeã€ã‚’ã‚¯ãƒªãƒƒã‚¯

**å³å´ã®ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã«ä»¥ä¸‹ã‚’è²¼ã‚Šä»˜ã‘:**

```javascript
export default {
  async fetch(request, env, ctx) {
    // PythonAnywhereã¸ã®ãƒ—ãƒ­ã‚­ã‚·
    const upstreamUrl = new URL(request.url);
    upstreamUrl.hostname = '1kzma1.pythonanywhere.com';
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    const cacheKey = new Request(upstreamUrl.toString(), {
      method: request.method,
      headers: request.headers,
    });
    
    let response = await env.CACHE.match(cacheKey);
    
    if (!response) {
      response = await fetch(upstreamUrl.toString(), {
        method: request.method,
        headers: request.headers,
        body: request.body,
      });
      
      // GET/HEADã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      if (request.method === 'GET' || request.method === 'HEAD') {
        // é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¯24æ™‚é–“ã€HTMLã¯1æ™‚é–“
        const cacheControl = upstreamUrl.pathname.match(/\.(js|css|jpg|png|gif|woff|woff2)$/)
          ? 86400  // 24æ™‚é–“
          : 3600;  // 1æ™‚é–“
        
        const cacheHeaders = new Headers(response.headers);
        cacheHeaders.set('Cache-Control', `public, max-age=${cacheControl}`);
        response = new Response(response.body, {
          status: response.status,
          statusText: response.statusText,
          headers: cacheHeaders,
        });
        
        ctx.waitUntil(env.CACHE.put(cacheKey, response.clone()));
      }
    }
    
    return response;
  }
};
```

ã€ŒSave and Deployã€ã‚’ã‚¯ãƒªãƒƒã‚¯

âœ… **ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ**

---

### ã‚¹ãƒ†ãƒƒãƒ—4: KV ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šï¼ˆ2åˆ†ï¼‰

#### 4-1: KV Bindings è¨­å®š

ãƒ¯ãƒ¼ã‚«ãƒ¼ç”»é¢ â†’ ã€ŒSettingsã€ã‚¿ãƒ–

```
å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ KV Namespace Bindings
```

#### 4-2: æ–°ã—ã„ KV ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ

```
1. ã€ŒCreate Namespaceã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. åå‰: cache
3. ã€ŒCreateã€
```

#### 4-3: ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¿½åŠ 

```
1. ãƒ¯ãƒ¼ã‚«ãƒ¼ç”»é¢ã«æˆ»ã‚‹
2. ã€ŒSettingsã€â†’ã€ŒKV Namespace Bindingsã€
3. ã€ŒAdd Bindingã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. å¤‰æ•°å: CACHE
5. ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹: ä¸Šã§ä½œæˆã—ãŸ cache ã‚’é¸æŠ
6. ã€ŒSaveã€
```

âœ… **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ãŸ**

---

### ã‚¹ãƒ†ãƒƒãƒ—5: Django è¨­å®šæ›´æ–°ï¼ˆ3åˆ†ï¼‰

#### 5-1: settings.py ç¢ºèª

[workpro/settings.py](workpro/settings.py) ã‚’ç¢ºèª

```python
# âœ… æ—¢ã«è¨­å®šæ¸ˆã¿
SECURE_PROXY_SSL_HEADER = ('HTTP_CF_VISITOR', '{"scheme":"https"}')
SECURE_SSL_REDIRECT = True
```

#### 5-2: PythonAnywhere ç’°å¢ƒå¤‰æ•°è¨­å®š

```
PythonAnywhere â†’ Web ã‚¿ãƒ–
â†’ ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ :

ALLOWED_HOSTS=1kzma1.pythonanywhere.com
CLOUDFLARE_ENABLED=True
```

âœ… **Djangoè¨­å®šå®Œäº†**

---

## ğŸ“ æ¤œè¨¼

### âœ… å‹•ä½œç¢ºèª

**ãƒ¯ãƒ¼ã‚«ãƒ¼URL ã§ã‚¢ã‚¯ã‚»ã‚¹:**
```
https://your-worker.your-subdomain.workers.dev
```

ç¢ºèªé …ç›®:
- [ ] ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆCSSï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹
- [ ] ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒªãƒ³ã‚¯ãŒå‹•ä½œã—ã¦ã„ã‚‹

**ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ç¢ºèª:**
```
F12 â†’ Network ã‚¿ãƒ–
Response Headers ã‚’ç¢ºèª:

CF-Cache-Status: HIT (ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‘½ä¸­)
CF-Cache-Status: MISS (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—)
Cache-Control: public, max-age=86400
```

---

### ğŸ” ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

**1å›ç›® (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—):** 500ms
**2å›ç›® (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š):** 80ms
**3å›ç›® (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š):** 75ms

**æœŸå¾…ã§ãã‚‹æ”¹å–„: 80ï½90% ã®å¿œç­”æ™‚é–“çŸ­ç¸®**

---

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### âŒ ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã§èµ·å‹•ã—ãªã„

**ç¢ºèª:**
```
1. Worker ã‚³ãƒ¼ãƒ‰æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãªã—
2. KV ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ CACHE ãŒå­˜åœ¨
3. ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€ŒCACHEã€ãŒè¨­å®šæ¸ˆã¿
```

**è§£æ±º:** ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã€ŒSave and Deployã€

### âŒ ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› :** ãƒ›ã‚¹ãƒˆåãŒé–“é•ã£ã¦ã„ã‚‹

**ç¢ºèª:**
```javascript
// ã‚³ãƒ¼ãƒ‰ã® ã“ã®éƒ¨åˆ†:
upstreamUrl.hostname = '1kzma1.pythonanywhere.com';
// â† ã“ã‚ŒãŒæ­£ã—ã„ã‹ç¢ºèª
```

### âŒ ã‚¹ã‚¿ã‚¤ãƒ«ãŒåæ˜ ã•ã‚Œãªã„

**åŸå› :** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„

**è§£æ±º:**
```
1. Ctrl + Shift + R ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
2. ã¾ãŸã¯ Cloudflare â†’ Cache â†’ Purge Everything
```

### âŒ ç®¡ç†ç”»é¢ï¼ˆ/adminï¼‰ãŒè¦‹ãˆãªã„

**åŸå› :** PythonAnywhere ã§èªè¨¼ãŒå¿…è¦

è§£æ±ºæ–¹æ³•:
```javascript
// ã‚¢ãƒ‰ãƒãƒ³ã‚¹: èªè¨¼æƒ…å ±ãƒ‘ã‚¹
if (upstreamUrl.pathname.startsWith('/admin')) {
  // èªè¨¼æƒ…å ±ã‚’ä¿æŒã™ã‚‹è¨­å®š
  response = await fetch(upstreamUrl.toString(), {
    method: request.method,
    headers: request.headers,
    credentials: 'include',
  });
}
```

---

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“å»¶é•·

```javascript
// ã‚³ãƒ¼ãƒ‰å†…ã§èª¿æ•´
const cacheControl = 604800; // 7æ—¥é–“ã«å¤‰æ›´
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: Gzipåœ§ç¸®æœ‰åŠ¹åŒ–

Cloudflare â†’ Speed â†’ åœ§ç¸®
```
åœ§ç¸®: Brotli ã«è¨­å®š
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ç”»åƒæœ€é©åŒ–

Cloudflare â†’ Speed â†’ ç”»åƒæœ€é©åŒ–
```
Polished: ON
WebP: ON
```

---

## ğŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

| ãƒ•ã‚¡ã‚¤ãƒ«ç¨® | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“ | ç”¨é€” |
|-----------|--------------|------|
| CSS, JS | 24æ™‚é–“ | é™çš„è³‡æº |
| ç”»åƒ | 24æ™‚é–“ | é™çš„è³‡æº |
| HTML | 1æ™‚é–“ | ãƒšãƒ¼ã‚¸ |
| API | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— | å‹•çš„ |

**æ—¢ã«ã‚³ãƒ¼ãƒ‰å†…ã«å®Ÿè£…æ¸ˆã¿ã§ã™ã€‚** âœ…

---

## ğŸ¯ è¨­å®šå®Œäº†ãƒã‚§ãƒƒã‚¯

- [ ] Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] Worker ä½œæˆ + ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] KV ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ
- [ ] ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®š
- [ ] Django settings.py ç¢ºèª
- [ ] PythonAnywhere ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] ãƒ¯ãƒ¼ã‚«ãƒ¼URL ã§ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª

---

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ã•ã‚‰ã«é«˜é€ŸåŒ–ã—ãŸã„å ´åˆ

```javascript
// Cloudflare Workers ã®ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ©Ÿèƒ½:
// 1. ç”»åƒãƒªã‚µã‚¤ã‚º
// 2. WebP è‡ªå‹•å¤‰æ›
// 3. CSS/JS ãƒŸãƒ‹ãƒ•ã‚¡ã‚¤
```

è©³ã—ãã¯ [Cloudflare Workers ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.cloudflare.com/workers/)

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Cloudflare Workers Guide](https://developers.cloudflare.com/workers/)
- [Cloudflare KV](https://developers.cloudflare.com/workers/runtime-apis/kv/)
- [Cache-Control HTTP Header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control)

---

**ã“ã‚Œã§å®Œå…¨ã«Cloudflareã«ã‚ˆã‚‹é«˜é€ŸåŒ–ãŒå®Ÿç¾ã§ãã¾ã™ï¼**

ğŸš€ **æœŸå¾…ã§ãã‚‹æ”¹å–„:**
- âœ… åˆå›: ç´„30ï½50% é«˜é€ŸåŒ–
- âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ç´„80ï½90% é«˜é€ŸåŒ–
- âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«é…ä¿¡: Cloudflareã‚¨ãƒƒã‚¸ã‹ã‚‰é…ä¿¡
- âœ… å®Œå…¨ç„¡æ–™

